---
title: "Investigation of Contributing Factors to Early Readmission of Patients with Diabetes using a Penalized Regression Model"
author: "Pouria Niknam"
date: "12/11/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

All required packages are looaded here.

```{r, error=FALSE, warning=FALSE, message=FALSE}
library(dplyr)
library(tidyverse)
library(scales)
library(pROC)
library(ISLR)
library(caret)
library(glmnet)
```

The dataset is loaded here.

```{r}
diabetes = read.csv('diabetic_data_initial.csv')
```

This chunk provides the dimensions of the dataset. 

```{r}
dim(diabetes)
rows <- nrow(diabetes)
columns <- ncol(diabetes)
```

This initial breakdown of readmission status.

```{r}
init_readmission <- count(diabetes,readmitted)
pct_readmission <- c(percent(init_readmission[1,2]/rows), percent(init_readmission[2,2]/rows), percent(init_readmission[3,2]/rows))
type_readmission <- c(init_readmission[1,1], init_readmission[2,1], init_readmission[3,1])
init_readmission <- data.frame(type_readmission, pct_readmission)
init_readmission
```

To maintain independence among encounters, only one encounter per patient is maintained in the data and additional encounters for that each patient will be removed. 

```{r, results='hide'}
diabetes <- diabetes[!duplicated(diabetes$patient_nbr), ]
```

The variable for readmission has 3 values in the original dataset: NO, <30, and >30. Since this study is focused on early readmission (<30 days), I will convert the "<30" value to YES and ">30" values to NO. No readmission and readmission after 30 days is treated equally for the purpose of this study.

```{r}
unique_rows <- nrow(diabetes)
diabetes$readmitted[diabetes$readmitted == "<30"] <- "YES"
diabetes$readmitted[diabetes$readmitted == ">30"] <- "NO"
```

Missing values in this dataset are filled with "?". To make handling of missing values easier, they are all converted to NA. The second line of code in this chunk summarizes the number of NAs in each column. Based on the variable and the number of NAs, a decision will be made about whether the variable should be entirely ommitted or the rows with missing values.

```{r}
diabetes[diabetes == "?"] <- NA
diabetes %>% summarise(across(everything(), ~ sum(is.na(.))))
```

Weight, payer code, and medical specialty variables have the highest percentage of missing values. Therefore, they will be removed entirely. 

```{r}
weight_napct <- percent(sum(is.na(diabetes$weight))/unique_rows)
payercode_napct <- percent(sum(is.na(diabetes$payer_code))/unique_rows)
medspecialty_napct <- percent(sum(is.na(diabetes$weight))/unique_rows)
missing_matrix <- matrix(c(weight_napct,payercode_napct,medspecialty_napct),ncol = 1, byrow = TRUE)
colnames(missing_matrix) <- c('Percentage of NAs')
rownames(missing_matrix) <- c('Weight', 'Payer Code', 'Medical Specialty')
missing_table <- as.table(missing_matrix)
missing_table
```

Columns weight, payer_code, and medical_specialty are removed from the dataset due to high percentage of missing values.Columns encounter_id and patient_nbr are also removed since they are not used in the modelling.

```{r}
diabetes <- subset(diabetes, select = -c(weight, payer_code, medical_specialty, encounter_id, patient_nbr))
```

Records without gender are set to NA to be removed.

```{r}
diabetes$gender[diabetes$gender == 'Unknown/Invalid'] <- NA
```

Missing values for race will be replaced with 'Other'. 

```{r}
diabetes$race[is.na(diabetes$race)] <- 'Other'
race_counts <- count(diabetes, race)
race_counts
```

Discharge disposition IDs mapped to their categorical values.

```{r}
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 1] <- 'Discharged to home'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 2] <- 'Discharged/transferred to another short term hospital'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 3] <- 'Discharged/transferred to SNF'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 4] <- 'Discharged/transferred to ICF'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 5] <- 'Discharged/transferred to another type of inpatient care institution'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 6] <- 'Discharged/transferred to home with home health service'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 7] <- 'Left AMA'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 8] <- 'Discharged/transferred to home under care of Home IV provider'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 9] <- 'Admitted as an inpatient to this hospital'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 10] <- 'Neonate discharged to another hospital for neonatal aftercare'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 11] <- 'Expired'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 12] <- 'Still patient or expected to return for outpatient services'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 13] <- 'Hospice / home'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 14] <- 'Hospice / medical facility'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 15] <- 'Discharged/transferred within this institution to Medicare approved swing bed'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 16] <- 'Discharged/transferred/referred another institution for outpatient services'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 17] <- 'Discharged/transferred/referred to this institution for outpatient services'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 18] <- 'Null'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 19] <- 'Expired at home. Medicaid only, hospice'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 20] <- 'Expired in a medical facility. Medicaid only, hospice'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 21] <- 'Expired, place unknown. Medicaid only, hospice'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 22] <- 'Discharged/transferred to another rehab fac including rehab units of a hospital'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 23] <- 'Discharged/transferred to a long term care hospital'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 24] <- 'Discharged/transferred to a nursing facility certified under Medicaid but not certified under Medicare'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 25] <- 'Not Mapped'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 26] <- 'Unknown/Invalid'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 27] <- 'Discharged/transferred to a federal health care facility'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 28] <- 'Discharged/transferred/referred to a psychiatric hospital of psychiatric distinct part unit of a hospital'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 29] <- 'Discharged/transferred to a Critical Access Hospital (CAH)'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 30] <- 'Discharged/transferred to another Type of Health Care Institution not Defined Elsewhere'
count(diabetes, discharge_disposition_id)
```

Discharge categories are grouped together to make it easier to use and analyze. All NAs are also removed.

```{r}
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 'Discharged/transferred to another short term hospital'] <- 'Discharged to Healthcare'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 'Discharged/transferred to SNF'] <- 'Discharged to Healthcare'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 'Discharged/transferred to ICF'] <- 'Discharged to Healthcare'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 'Discharged/transferred to another type of inpatient care institution'] <- 'Discharged to Healthcare'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 'Discharged/transferred to home with home health service'] <- 'Discharged to home'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 'Discharged/transferred to home under care of Home IV provider'] <- 'Discharged to home'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 'Admitted as an inpatient to this hospital'] <- 'N/A'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 'Neonate discharged to another hospital for neonatal aftercare'] <- 'Discharged to Healthcare'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 'Expired'] <- NA
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 'Still patient or expected to return for outpatient services'] <- 'N/A'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 'Hospice / home'] <- 'Hospice'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 'Hospice / medical facility'] <- 'Hospice'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 'Discharged/transferred within this institution to Medicare approved swing bed'] <- 'Discharged to Healthcare'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 'Discharged/transferred/referred another institution for outpatient services'] <- 'Discharged to Healthcare'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 'Discharged/transferred/referred to this institution for outpatient services'] <- 'Discharged to Healthcare'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 'Null'] <- 'N/A'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 'Expired at home. Medicaid only, hospice'] <- NA
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 'Expired in a medical facility. Medicaid only, hospice'] <- NA
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 'Expired, place unknown. Medicaid only, hospice'] <- NA
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 'Discharged/transferred to another rehab fac including rehab units of diabetes <- na.omit(diabetes)a hospital'] <- 'Discharged to Healthcare'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 'Discharged/transferred to a long term care hospital'] <- 'Discharged to Healthcare'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 'Discharged/transferred to a nursing facility certified under Medicaid but not certified under Medicare'] <- 'Discharged to Healthcare'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 'Not Mapped'] <- 'N/A'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 'Unknown/Invalid'] <- 'N/A'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 'Discharged/transferred to a federal health care facility'] <- 'Discharged to Healthcare'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 'Discharged/transferred/referred to a psychiatric hospital of psychiatric distinct part unit of a hospital'] <- 'Discharged to Healthcare'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 'Discharged/transferred to a Critical Access Hospital (CAH)'] <- 'Discharged to Healthcare'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 'Discharged/transferred to another Type of Health Care Institution not Defined Elsewhere'] <- 'Discharged to Healthcare'
diabetes$discharge_disposition_id[diabetes$discharge_disposition_id == 'Discharged/transferred to another rehab fac including rehab units of a hospital'] <- 'Discharged to Healthcare'
diabetes <- na.omit(diabetes)
count(diabetes, discharge_disposition_id)
```

Admission type IDs mapped to their categorical values.

```{r}
diabetes$admission_type_id[diabetes$admission_type_id == 1] <- 'Emergency'
diabetes$admission_type_id[diabetes$admission_type_id == 2] <- 'Urgent'
diabetes$admission_type_id[diabetes$admission_type_id == 3] <- 'Elective'
diabetes$admission_type_id[diabetes$admission_type_id == 4] <- 'Not Mapped'
diabetes$admission_type_id[diabetes$admission_type_id == 5] <- 'N/A'
diabetes$admission_type_id[diabetes$admission_type_id == 6] <- 'Null'
diabetes$admission_type_id[diabetes$admission_type_id == 7] <- 'Emergency'
diabetes$admission_type_id[diabetes$admission_type_id == 8] <- 'Not Mapped'
```


Admission source IDs mapped to their categorical values.

```{r}
diabetes$admission_source_id[diabetes$admission_source_id == 1] <- 'Physician Referral'
diabetes$admission_source_id[diabetes$admission_source_id == 2] <- 'Clinic Referral'
diabetes$admission_source_id[diabetes$admission_source_id == 3] <- 'HMO Referral'
diabetes$admission_source_id[diabetes$admission_source_id == 4] <- 'Transfer from a hospital'
diabetes$admission_source_id[diabetes$admission_source_id == 5] <- 'Transfer from a Skilled Nursing Facility (SNF)'
diabetes$admission_source_id[diabetes$admission_source_id == 6] <- 'Transfer from another health care facility'
diabetes$admission_source_id[diabetes$admission_source_id == 7] <- 'Emergency Room'
diabetes$admission_source_id[diabetes$admission_source_id == 8] <- 'Court/Law Enforcement'
diabetes$admission_source_id[diabetes$admission_source_id == 9] <- 'N/A'
diabetes$admission_source_id[diabetes$admission_source_id == 10] <- 'Transfer from critial access hospital'
diabetes$admission_source_id[diabetes$admission_source_id == 11] <- 'Normal Delivery'
diabetes$admission_source_id[diabetes$admission_source_id == 12] <- 'Premature Delivery'
diabetes$admission_source_id[diabetes$admission_source_id == 13] <- 'Sick Baby'
diabetes$admission_source_id[diabetes$admission_source_id == 14] <- 'Extramural Birth'
diabetes$admission_source_id[diabetes$admission_source_id == 15] <- 'N/A'
diabetes$admission_source_id[diabetes$admission_source_id == 17] <- 'Null'
diabetes$admission_source_id[diabetes$admission_source_id == 18] <- 'Transfer From Another Home Health Agency'
diabetes$admission_source_id[diabetes$admission_source_id == 19] <- 'Readmission to Same Home Health Agency'
diabetes$admission_source_id[diabetes$admission_source_id == 20] <- 'Not Mapped'
diabetes$admission_source_id[diabetes$admission_source_id == 21] <- 'Unknown/Invalid'
diabetes$admission_source_id[diabetes$admission_source_id == 22] <- 'Transfer from hospital inpt/same fac reslt in a sep claim'
diabetes$admission_source_id[diabetes$admission_source_id == 23] <- 'Born inside this hospital'
diabetes$admission_source_id[diabetes$admission_source_id == 24] <- 'Born outside this hospital'
diabetes$admission_source_id[diabetes$admission_source_id == 25] <- 'Transfer from Ambulatory Surgery Center'
diabetes$admission_source_id[diabetes$admission_source_id == 26] <- 'Transfer from Hospice'
```

Counts for different admission types. 

```{r}
count(diabetes, admission_type_id)
```

'Not Mapped' and 'NULL' are also mapped to 'N/A' to reduce number of unhelpful levels. 

```{r}
diabetes$admission_type_id[diabetes$admission_type_id == 'Not Mapped'] <- 'N/A'
diabetes$admission_type_id[diabetes$admission_type_id == 'Null'] <- 'N/A'
count(diabetes, admission_type_id)
```

Counts for admission sources.

```{r}
count(diabetes, admission_source_id)
```

Admission source IDs are re-mapped by grouping sources with low encounter count.

```{r}
diabetes$admission_source_id[diabetes$admission_source_id == 'HMO Referral'] <- 'Referral'
diabetes$admission_source_id[diabetes$admission_source_id == 'Physician Referral'] <- 'Referral'
diabetes$admission_source_id[diabetes$admission_source_id == 'Clinic Referral'] <- 'Referral'
diabetes$admission_source_id[diabetes$admission_source_id == 'Transfer from a hospital'] <- 'Transfer'
diabetes$admission_source_id[diabetes$admission_source_id == 'Transfer from a Skilled Nursing Facility (SNF)'] <- 'Transfer'
diabetes$admission_source_id[diabetes$admission_source_id == 'Transfer from another health care facility'] <- 'Transfer'
diabetes$admission_source_id[diabetes$admission_source_id == 'Court/Law Enforcement'] <- 'Other'
diabetes$admission_source_id[diabetes$admission_source_id == 'Transfer from critial access hospital'] <- 'Transfer'
diabetes$admission_source_id[diabetes$admission_source_id == 'Normal Delivery'] <- 'Other'
diabetes$admission_source_id[diabetes$admission_source_id == 'Sick Baby'] <- 'Other'
diabetes$admission_source_id[diabetes$admission_source_id == 'Extramural Birth'] <- 'Other'
diabetes$admission_source_id[diabetes$admission_source_id == 'Null'] <- 'N/A'
diabetes$admission_source_id[diabetes$admission_source_id == 'Transfer From Another Home Health Agency'] <- 'Transfer'
diabetes$admission_source_id[diabetes$admission_source_id == 'Readmission to Same Home Health Agency'] <- 'Other'
diabetes$admission_source_id[diabetes$admission_source_id == 'Not Mapped'] <- 'N/A'
diabetes$admission_source_id[diabetes$admission_source_id == 'Unknown/Invalid'] <- 'N/A'
diabetes$admission_source_id[diabetes$admission_source_id == 'Transfer from hospital inpt/same fac reslt in a sep claim'] <- 'Transfer'
diabetes$admission_source_id[diabetes$admission_source_id == 'Born inside this hospital'] <- 'Other'
diabetes$admission_source_id[diabetes$admission_source_id == 'Born outside this hospital'] <- 'Other'
diabetes$admission_source_id[diabetes$admission_source_id == 'Transfer from Ambulatory Surgery Center'] <- 'Transfer'
diabetes$admission_source_id[diabetes$admission_source_id == 'Transfer from Hospice'] <- 'Transfer'
count(diabetes, admission_source_id)
```

Counts for different age ranges. 

```{r}
diabetes$age[diabetes$age == '[0-10)' | diabetes$age == '[10-20)'] <- '[0-20)'
diabetes$age[diabetes$age == '[20-30)' | diabetes$age == '[30-40)' | diabetes$age == '[40-50)' | diabetes$age == '[50-60)'] <- '[20-60)'
diabetes$age[diabetes$age == '[60-70)' | diabetes$age == '[70-80)' | diabetes$age == '[80-90)' | diabetes$age == '[90-100)'] <- '[60-100) '
count(diabetes, age)
```

All rows that have any missing values were removed as well since they don't constitute a high percentage. Only 3% percent of data is removed in the cleaning process.

```{r}
clean_rows <- nrow(diabetes)
percent((unique_rows-clean_rows)/unique_rows)
```



```{r}
init_readmission2 <- count(diabetes,readmitted)
pct_readmission2 <- c(percent(init_readmission2[1,2]/clean_rows), percent(init_readmission2[2,2]/clean_rows))
type_readmission2 <- c(init_readmission2[1,1], init_readmission2[2,1])
init_readmission2 <- data.frame(type_readmission2, pct_readmission2)
init_readmission2
```

Counts for males and females.

```{r}
gender_counts <- count(diabetes, gender)
male_pct <- percent(gender_counts[2,2]/clean_rows)
female_pct <- percent(gender_counts[1,2]/clean_rows)
male_pct
female_pct
```

This chunk tests for significant statistical difference between readmission rate of African Americans and Caucasians. The test result indicates that there is no significant statistical difference between readmission rates for African Americans and Caucasians.

```{r}
black_readmitted <- nrow(diabetes[diabetes$race == 'AfricanAmerican' & diabetes$readmitted == 'YES', ])
caucasian_readmitted <- nrow(diabetes[diabetes$race == 'Caucasian' & diabetes$readmitted == 'YES', ])
black_count <- race_counts[1,2]
caucasian_count <- race_counts[3,2]
black_proptest <- prop.test(x = c(black_readmitted,caucasian_readmitted), n = c(black_count,caucasian_count), alternative = 'two.sided', correct = FALSE)
black_proptest
```

This chunk tests for significant statistical difference between readmission rate of Hispanics and Caucasians. The test result indicates that there is a significant statistical difference between readmission rates for Hispanics and Caucasians.

```{r}
hispanic_readmitted <- nrow(diabetes[diabetes$race == 'Hispanic' & diabetes$readmitted == 'YES', ])
hispanic_count <- race_counts[1,2]
hispanic_proptest <- prop.test(x = c(hispanic_readmitted,caucasian_readmitted), n = c(hispanic_count,caucasian_count), alternative = 'two.sided', correct = FALSE)
hispanic_proptest
```

This test indicates that readmission rate among Hispanics is significantly lower compared to African Americans.

```{r}
hispanic_black <- prop.test(x = c(hispanic_readmitted, black_readmitted), n = c(hispanic_count, black_count), alternative = 'less', correct = FALSE)
hispanic_black
```

This test indicates that readmission rate among Hispanics is significantly lower compared to Caucasians.

```{r}
hispanic_proptest2 <- prop.test(x = c(hispanic_readmitted,caucasian_readmitted), n = c(hispanic_count,caucasian_count), alternative = 'less', correct = FALSE)
hispanic_proptest2
```

This chunk tests for significant statistical difference between readmission rate of Asians and Caucasians. The test result indicates that there is no significant statistical difference between readmission rates for Asians and Caucasians.

```{r}
asian_readmitted <- nrow(diabetes[diabetes$race == 'Asian' & diabetes$readmitted == 'YES', ])
asian_count <- race_counts[2,2]
asian_proptest <- prop.test(x = c(asian_readmitted,caucasian_readmitted), n = c(asian_count,caucasian_count), alternative = 'two.sided', correct = FALSE)
asian_proptest
```

This chunk tests for significant statistical difference between readmission rate of Males and Females The test result indicates that there is no significant statistical difference between readmission rates for Males and Females.

```{r}
male_readmitted <- nrow(diabetes[diabetes$gender == 'Male' & diabetes$readmitted == 'YES', ])
female_readmitted <- nrow(diabetes[diabetes$gender == 'Female' & diabetes$readmitted == 'YES', ])
female_count <- gender_counts[1,2]
male_count <- gender_counts[2,2]

gender_proptest <- prop.test(x = c(male_readmitted,female_readmitted), n = c(male_count,female_count), alternative = 'two.sided', correct = FALSE)
asian_proptest
```

The next three chunks convert ICD-9 codes for diagnoses into categories for ease of understanding due to their technical nature. 

```{r}
diabetes$diag_1[(diabetes$diag_1 >= 390 & diabetes$diag_1 <= 459) | diabetes$diag_1 == 785] <- 'Circulatory'
diabetes$diag_1[(diabetes$diag_1 >= 460 & diabetes$diag_1 <= 519) | diabetes$diag_1 == 786] <- 'Respiratory'
diabetes$diag_1[(diabetes$diag_1 >= 520 & diabetes$diag_1 <= 579) | diabetes$diag_1 == 787 | diabetes$diag_1 == 789 | diabetes$diag_1 == 783] <- 'Digestive'
diabetes$diag_1[(diabetes$diag_1 >= 250 & diabetes$diag_1 < 251)] <- 'Diabetes'
diabetes$diag_1[(diabetes$diag_1 >= 800 & diabetes$diag_1 <= 999)] <- 'Injury'
diabetes$diag_1[(diabetes$diag_1 >= 710 & diabetes$diag_1 <= 739)] <- 'Musculoskeletal'
diabetes$diag_1[(diabetes$diag_1 >= 580 & diabetes$diag_1 <= 629) | diabetes$diag_1 == 788] <- 'Genitourinary'
diabetes$diag_1[(diabetes$diag_1 >= 140 & diabetes$diag_1 <= 239)] <- 'Neoplasms'
diabetes$diag_1[(diabetes$diag_1 >= 790 & diabetes$diag_1 <= 799)] <- 'Neoplasms'
diabetes$diag_1[(diabetes$diag_1 >= 240 & diabetes$diag_1 <= 249)] <- 'Neoplasms'
diabetes$diag_1[(diabetes$diag_1 >= 251 & diabetes$diag_1 <= 279)] <- 'Neoplasms'
diabetes$diag_1[(diabetes$diag_1 >= 680 & diabetes$diag_1 <= 709) | diabetes$diag_1 == 782] <- 'Neoplasms'
diabetes$diag_1[diabetes$diag_1 == 780 | diabetes$diag_1 == 781 | diabetes$diag_1 == 784] <- 'Neoplasms'
diabetes$diag_1[(diabetes$diag_1 >= 1 & diabetes$diag_1 <= 139)] <- 'Other'
diabetes$diag_1[(diabetes$diag_1 >= 290 & diabetes$diag_1 <= 319)] <- 'Other'
diabetes$diag_1[(diabetes$diag_1 >= 280 & diabetes$diag_1 <= 289)] <- 'Other'
diabetes$diag_1[(diabetes$diag_1 >= 320 & diabetes$diag_1 <= 359)] <- 'Other'
diabetes$diag_1[(diabetes$diag_1 >= 630 & diabetes$diag_1 <= 679)] <- 'Other'
diabetes$diag_1[(diabetes$diag_1 >= 360 & diabetes$diag_1 <= 389)] <- 'Other'
diabetes$diag_1[(diabetes$diag_1 >= 740 & diabetes$diag_1 <= 759)] <- 'Other'
diabetes$diag_1[startsWith(diabetes$diag_1,'E')] <- 'Other'
diabetes$diag_1[startsWith(diabetes$diag_1,'V')] <- 'Other'
diabetes$diag_1[diabetes$diag_1 == '8'] <- 'Other'
diabetes$diag_1[diabetes$diag_1 == '36'] <- 'Other'
diabetes$diag_1[diabetes$diag_1 == '39'] <- 'Other'
diabetes$diag_1[diabetes$diag_1 == '52'] <- 'Other'
diabetes$diag_1[diabetes$diag_1 == '58'] <- 'Other'
diabetes$diag_1[diabetes$diag_1 == '78'] <- 'Other'
diabetes$diag_1[diabetes$diag_1 == '79'] <- 'Other'
```

```{r}
diabetes$diag_2[(diabetes$diag_2 >= 390 & diabetes$diag_2 <= 459) | diabetes$diag_2 == 785] <- 'Circulatory'
diabetes$diag_2[(diabetes$diag_2 >= 460 & diabetes$diag_2 <= 519) | diabetes$diag_2 == 786] <- 'Respiratory'
diabetes$diag_2[(diabetes$diag_2 >= 520 & diabetes$diag_2 <= 579) | diabetes$diag_2 == 787 | diabetes$diag_2 == 789 | diabetes$diag_2 == 783] <- 'Digestive'
diabetes$diag_2[(diabetes$diag_2 >= 250 & diabetes$diag_2 < 251)] <- 'Diabetes'
diabetes$diag_2[(diabetes$diag_2 >= 800 & diabetes$diag_2 <= 999)] <- 'Injury'
diabetes$diag_2[(diabetes$diag_2 >= 710 & diabetes$diag_2 <= 739)] <- 'Musculoskeletal'
diabetes$diag_2[(diabetes$diag_2 >= 580 & diabetes$diag_2 <= 629) | diabetes$diag_2 == 788] <- 'Genitourinary'
diabetes$diag_2[(diabetes$diag_2 >= 140 & diabetes$diag_2 <= 239)] <- 'Neoplasms'
diabetes$diag_2[(diabetes$diag_2 >= 790 & diabetes$diag_2 <= 799)] <- 'Neoplasms'
diabetes$diag_2[(diabetes$diag_2 >= 240 & diabetes$diag_2 <= 249)] <- 'Neoplasms'
diabetes$diag_2[(diabetes$diag_2 >= 251 & diabetes$diag_2 <= 279)] <- 'Neoplasms'
diabetes$diag_2[(diabetes$diag_2 >= 680 & diabetes$diag_2 <= 709) | diabetes$diag_2 == 782] <- 'Neoplasms'
diabetes$diag_2[diabetes$diag_2 == 780 | diabetes$diag_2 == 781 | diabetes$diag_2 == 784] <- 'Neoplasms'
diabetes$diag_2[(diabetes$diag_2 >= 1 & diabetes$diag_2 <= 139)] <- 'Other'
diabetes$diag_2[(diabetes$diag_2 >= 290 & diabetes$diag_2 <= 319)] <- 'Other'
diabetes$diag_2[(diabetes$diag_2 >= 280 & diabetes$diag_2 <= 289)] <- 'Other'
diabetes$diag_2[(diabetes$diag_2 >= 320 & diabetes$diag_2 <= 359)] <- 'Other'
diabetes$diag_2[(diabetes$diag_2 >= 630 & diabetes$diag_2 <= 679)] <- 'Other'
diabetes$diag_2[(diabetes$diag_2 >= 360 & diabetes$diag_2 <= 389)] <- 'Other'
diabetes$diag_2[(diabetes$diag_2 >= 740 & diabetes$diag_2 <= 759)] <- 'Other'
diabetes$diag_2[startsWith(diabetes$diag_2,'E')] <- 'Other'
diabetes$diag_2[startsWith(diabetes$diag_2,'V')] <- 'Other'
diabetes$diag_2[diabetes$diag_2 == '8'] <- 'Other'
diabetes$diag_2[diabetes$diag_2 == '36'] <- 'Other'
diabetes$diag_2[diabetes$diag_2 == '39'] <- 'Other'
diabetes$diag_2[diabetes$diag_2 == '52'] <- 'Other'
diabetes$diag_2[diabetes$diag_2 == '58'] <- 'Other'
diabetes$diag_2[diabetes$diag_2 == '78'] <- 'Other'
diabetes$diag_2[diabetes$diag_2 == '79'] <- 'Other'
diabetes$diag_2[diabetes$diag_2 == '46'] <- 'Other'
```

```{r}
diabetes$diag_3[(diabetes$diag_3 >= 390 & diabetes$diag_3 <= 459) | diabetes$diag_3 == 785] <- 'Circulatory'
diabetes$diag_3[(diabetes$diag_3 >= 460 & diabetes$diag_3 <= 519) | diabetes$diag_3 == 786] <- 'Respiratory'
diabetes$diag_3[(diabetes$diag_3 >= 520 & diabetes$diag_3 <= 579) | diabetes$diag_3 == 787 | diabetes$diag_3 == 789 | diabetes$diag_3 == 783] <- 'Digestive'
diabetes$diag_3[(diabetes$diag_3 >= 250 & diabetes$diag_3 < 251)] <- 'Diabetes'
diabetes$diag_3[(diabetes$diag_3 >= 800 & diabetes$diag_3 <= 999)] <- 'Injury'
diabetes$diag_3[(diabetes$diag_3 >= 710 & diabetes$diag_3 <= 739)] <- 'Musculoskeletal'
diabetes$diag_3[(diabetes$diag_3 >= 580 & diabetes$diag_3 <= 629) | diabetes$diag_3 == 788] <- 'Genitourinary'
diabetes$diag_3[(diabetes$diag_3 >= 140 & diabetes$diag_3 <= 239)] <- 'Neoplasms'
diabetes$diag_3[(diabetes$diag_3 >= 790 & diabetes$diag_3 <= 799)] <- 'Neoplasms'
diabetes$diag_3[(diabetes$diag_3 >= 240 & diabetes$diag_3 <= 249)] <- 'Neoplasms'
diabetes$diag_3[(diabetes$diag_3 >= 251 & diabetes$diag_3 <= 279)] <- 'Neoplasms'
diabetes$diag_3[(diabetes$diag_3 >= 680 & diabetes$diag_3 <= 709) | diabetes$diag_3 == 782] <- 'Neoplasms'
diabetes$diag_3[diabetes$diag_3 == 780 | diabetes$diag_3 == 781 | diabetes$diag_3 == 784] <- 'Neoplasms'
diabetes$diag_3[(diabetes$diag_3 >= 1 & diabetes$diag_3 <= 139)] <- 'Other'
diabetes$diag_3[(diabetes$diag_3 >= 290 & diabetes$diag_3 <= 319)] <- 'Other'
diabetes$diag_3[(diabetes$diag_3 >= 280 & diabetes$diag_3 <= 289)] <- 'Other'
diabetes$diag_3[(diabetes$diag_3 >= 320 & diabetes$diag_3 <= 359)] <- 'Other'
diabetes$diag_3[(diabetes$diag_3 >= 630 & diabetes$diag_3 <= 679)] <- 'Other'
diabetes$diag_3[(diabetes$diag_3 >= 360 & diabetes$diag_3 <= 389)] <- 'Other'
diabetes$diag_3[(diabetes$diag_3 >= 740 & diabetes$diag_3 <= 759)] <- 'Other'
diabetes$diag_3[startsWith(diabetes$diag_3,'E')] <- 'Other'
diabetes$diag_3[startsWith(diabetes$diag_3,'V')] <- 'Other'
diabetes$diag_3[diabetes$diag_3 == '8'] <- 'Other'
diabetes$diag_3[diabetes$diag_3 == '36'] <- 'Other'
diabetes$diag_3[diabetes$diag_3 == '39'] <- 'Other'
diabetes$diag_3[diabetes$diag_3 == '52'] <- 'Other'
diabetes$diag_3[diabetes$diag_3 == '58'] <- 'Other'
diabetes$diag_3[diabetes$diag_3 == '78'] <- 'Other'
diabetes$diag_3[diabetes$diag_3 == '79'] <- 'Other'
diabetes$diag_3[diabetes$diag_3 == '46'] <- 'Other'
diabetes$diag_3[diabetes$diag_3 == '14'] <- 'Other'
```

Breakdown of percentage of main diagnoses in the data

```{r}
main_diag <- count(diabetes,diag_1)
main_diag_tab <- matrix(percent(main_diag$n/clean_rows), ncol = 1, byrow = TRUE)
rownames(main_diag_tab) <- main_diag$diag_1
colnames(main_diag_tab) <- c('% of encounters')
main_diag_tab <- as.table(main_diag_tab)
main_diag_tab
```

Distribution of A1c results in the data

```{r}
a1c_counts <- count(diabetes,A1Cresult)
a1c_counts
```

The following three chunks test for statistically significant differences among different A1c levels. The results indicate no statistically significant differences in readmission based on A1c levels.

```{r}
a1c_7_readmitted <- nrow(diabetes[diabetes$A1Cresult == '>7' & diabetes$readmitted == 'YES', ])
a1c_7_count <- a1c_counts[1,2]
a1c_8_readmitted <- nrow(diabetes[diabetes$A1Cresult == '>8' & diabetes$readmitted == 'YES', ])
a1c_8_count <- a1c_counts[2,2]
a1c_7_8_proptest <- prop.test(x = c(a1c_7_readmitted,a1c_8_readmitted), n = c(a1c_7_count,a1c_8_count), alternative = 'two.sided', correct = FALSE)
a1c_7_8_proptest
```

Test of proportion between encounters with A1c >7% and normal A1c levels. 

```{r}
a1c_norm_readmitted <- nrow(diabetes[diabetes$A1Cresult == 'Norm' & diabetes$readmitted == 'YES', ])
a1c_norm_count <- a1c_counts[4,2]
a1c_7_norm_proptest <- prop.test(x = c(a1c_7_readmitted,a1c_norm_readmitted), n = c(a1c_7_count,a1c_norm_count), alternative = 'two.sided', correct = FALSE)
a1c_7_norm_proptest
```

Test of proportion between encounters with A1c >8% and normal A1c levels. 

```{r}
a1c_8_norm_proptest <- prop.test(x = c(a1c_8_readmitted,a1c_norm_readmitted), n = c(a1c_8_count,a1c_norm_count), alternative = 'two.sided', correct = FALSE)
a1c_8_norm_proptest
```

Test of independence for age indicates that age and early readmission are not independent.

```{r}
age_readmission <- table(diabetes$age, diabetes$readmitted)
chisq.test(age_readmission, correct = FALSE)
```

This test indicates that rate of readmission in patients older than 60 is significantly higher.

```{r}
prop.test(x = c(age_readmission[2,2], age_readmission[3,2]), n = c((age_readmission[2,2]+age_readmission[2,1]), (age_readmission[3,2]+age_readmission[3,1])), alternative = 'less', correct = FALSE)
```

Since patients under 20 are a very small percentage of the the data, test of independence is repeated without those encounters. The result confirm the result for the relation of age and readmission for the entire dataset.

```{r}
age_readmission2 <- age_readmission[-1,]
age_readmission2
chisq.test(age_readmission2, correct = FALSE)
```

Test of independence for gender indicates that gender and early readmission are independent.

```{r}
gender_readmission <- table(diabetes$gender, diabetes$readmitted)
chisq.test(gender_readmission, correct = FALSE)
```

Test of independence for race indicates that race and early readmission are not independent.

```{r}
race_readmission <- table(diabetes$race, diabetes$readmitted)
chisq.test(race_readmission, correct = FALSE)
```

Test of independence for A1c result indicates that A1c results and early readmission are independent.

```{r}
a1c_readmission <- table(diabetes$A1Cresult, diabetes$readmitted)
chisq.test(a1c_readmission, correct = FALSE)
```

Test of independence for A1c result for all patients who had a test conducted indicates that A1c results and early readmission are independent.

```{r}
a1c_readmission2 <- a1c_readmission[-3,]
chisq.test(a1c_readmission2, correct = FALSE)
```

Test of independence for admission type indicates that admission type and early readmission are not independent.

```{r}
admission_readmission <- table(diabetes$admission_type_id, diabetes$readmitted)
chisq.test(admission_readmission, correct = FALSE)
```

Test of independence for main diagnosis indicates that main diagnosis and early readmission are not independent.

```{r}
maindiag_readmission <- table(diabetes$diag_1, diabetes$readmitted)
chisq.test(maindiag_readmission, correct = FALSE)
```

Test of independence for patient using diabetes medication indicates that diabetes medication use and early readmission are not independent.

```{r}
diabetesmed_readmission <- table(diabetes$diabetesMed, diabetes$readmitted)
chisq.test(diabetesmed_readmission, correct = FALSE)
```

Test of independence for insulin change indicates that insulin change and early readmission are not independent.

```{r}
insulin_readmission <- table(diabetes$insulin, diabetes$readmitted)
chisq.test(insulin_readmission, correct = FALSE)
```

Test of independence for medication change indicates that medication change and early readmission are not independent.

```{r}
medchange_readmission <- table(diabetes$change, diabetes$readmitted)
chisq.test(medchange_readmission, correct = FALSE)
```

These variables are removed since they have only 1 level which doesn't allow training of a logistic regression model.

```{r}
diabetes <- subset(diabetes, select = -c(examide, glimepiride.pioglitazone, citoglipton))
```

Removing all medication variables and non-primary diagnoses. 

```{r}
diabetes <- diabetes[-c(20:39)]
diabetes <- subset(diabetes, select = -c(diag_2,diag_3))
```

Setting all categorical variables as factors. 

```{r}
diabetes$race <- as.factor(diabetes$race)
diabetes$gender <- as.factor(diabetes$gender)
diabetes$age <- as.factor(diabetes$age)
diabetes$admission_type_id <- as.factor(diabetes$admission_type_id)
diabetes$admission_source_id <- as.factor(diabetes$admission_source_id)
diabetes$discharge_disposition_id <- as.factor(diabetes$discharge_disposition_id)
diabetes$diag_1 <- as.factor(diabetes$diag_1)
#diabetes$diag_2 <- as.factor(diabetes$diag_2)
#diabetes$diag_3 <- as.factor(diabetes$diag_3)
diabetes$max_glu_serum <- as.factor(diabetes$max_glu_serum)
diabetes$A1Cresult <- as.factor(diabetes$A1Cresult)
#diabetes$insulin <- as.factor(diabetes$insulin)
diabetes$diabetesMed <- as.factor(diabetes$diabetesMed)
diabetes$change <- as.factor(diabetes$change)
diabetes$readmitted <- as.factor(diabetes$readmitted)
```

Standardizing all numeric variables.

```{r}
#diabetes$time_in_hospital <- (diabetes$time_in_hospital-mean(diabetes$time_in_hospital))/sd(diabetes$time_in_hospital)
#diabetes$num_lab_procedures <- (diabetes$num_lab_procedures-mean(diabetes$num_lab_procedures))/sd(diabetes$num_lab_procedures)
#diabetes$num_procedures <- (diabetes$num_procedures-mean(diabetes$num_procedures))/sd(diabetes$num_procedures)
#diabetes$num_medications <- (diabetes$num_medications-mean(diabetes$num_medications))/sd(diabetes$num_medications)
#diabetes$number_outpatient <- (diabetes$number_outpatient-mean(diabetes$number_outpatient))/sd(diabetes$number_outpatient)
#diabetes$number_inpatient <- (diabetes$number_inpatient-mean(diabetes$number_inpatient))/sd(diabetes$number_inpatient)
#diabetes$number_diagnoses <- (diabetes$number_diagnoses-mean(diabetes$number_diagnoses))/sd(diabetes$number_diagnoses)
#diabetes$number_emergency <- (diabetes$number_emergency-mean(diabetes$number_emergency))/sd(diabetes$number_emergency)
```

10-fold cross-validation without penalizing. 

```{r}
set.seed(123)
n = dim(diabetes)[1]
k = 10
groups = c(rep(1:k,floor(n/k)),1:(n-floor(n/k)*k))
cvgroups = sample(groups,n)
predictvals = rep(-1,n)
for(i in 1:k){
  groupi = (cvgroups == i)
  fit = glm(readmitted ~ ., data = diabetes[!groupi,], family = 'binomial')
  predictvals[groupi] = predict(fit, diabetes[groupi,], type = 'response')
}
```

Summary of the base model

```{r}
summary(fit)
```

ROC Curve and AUC

```{r}
logistic_reg_roc <- roc(response=diabetes$readmitted,predictor=predictvals)
plot.roc(logistic_reg_roc)
logistic_reg_auc <- auc(logistic_reg_roc)
logistic_reg_auc
```
Calculation of Sensitivity, Specificity, Positive Predictive Value, and Negative Predictive Value

```{r}
error_rate <- table(predictvals > 0.5, diabetes$readmitted)
sensitivity <- error_rate[2,2]/(error_rate[2,2]+error_rate[1,2])*100
FP_rate <- error_rate[2,1]/(error_rate[2,1]+error_rate[1,1])*100
error_rate
sensitivity
FP_rate
ppv <- error_rate[2,2]/(error_rate[2,2]+error_rate[1,1])*100
npv <- error_rate[1,1]/(error_rate[1,1]+error_rate[1,2])*100
ppv
npv
```

The clean dataset used analysis is written to a file. 

```{r}
#write.csv(diabetes, file = "Clean_diabetes.csv", row.names = FALSE)
```

Splitting the dataset into a training set and a test set. 

```{r}
#set.seed(123)
training.samples <- diabetes$readmitted %>% 
  createDataPartition(p = 0.8, list = FALSE)
train.data  <- diabetes[training.samples, ]
test.data <- diabetes[-training.samples, ]
```

converting the training set to matrix for use in elastic net.

```{r}
# Dumy code categorical predictor variables
x <- model.matrix(readmitted~., train.data)[,-1]
# Convert the outcome (class) to a numerical variable
y <- ifelse(train.data$readmitted == "YES", 1, 0)
```

Cross-validation to find the best lambda

```{r}
cv.enet <- cv.glmnet(x, y, alpha = 0.2, nfolds=10, family = "binomial")
```

Plot of different lambda values versus error

```{r}
plot(cv.enet)
```

AUC versus log of lambda

```{r}
auc_enet <- cv.glmnet(x, y, alpha = 0.2, nfolds=10, family="binomial", type.measure="auc")
plot(auc_enet)
```

coefficients versus log of lambda

```{r}
plot(cv.enet$glmnet.fit, 
     "lambda", label=FALSE)
```

minimum lambda

```{r}
cv.enet$lambda.min
```

lambda for simplest model within one standard error of the optimal lambda value

```{r}
cv.enet$lambda.1se
```

Optimal penalized model and its accuracy

```{r}
# Final model with lambda.min
enet.model1 <- glmnet(x, y, alpha = 0.2, family = "binomial",
                      lambda = cv.enet$lambda.min)
# Make prediction on test data
x.test <- model.matrix(readmitted ~., test.data)[,-1]
probabilities1 <- enet.model1 %>% predict(newx = x.test)
predicted.classes1 <- ifelse(probabilities1 > 0.5, "YES", "NO")
# Model accuracy
observed.classes <- test.data$readmitted
mean(predicted.classes1 == observed.classes)
```

Simplest penalized model and its accuracy

```{r}
# Final model with lambda.min
enet.model2 <- glmnet(x, y, alpha = 0.2, family = "binomial",
                      lambda = cv.enet$lambda.1se)
# Make prediction on test data
#x.test2 <- model.matrix(readmitted ~., test.data)[,-1]
probabilities2 <- enet.model2 %>% predict(newx = x.test)
predicted.classes2 <- ifelse(probabilities2 > 0.5, "YES", "NO")
# Model accuracy
mean(predicted.classes2 == observed.classes)
```

Full logistic regression model and its accuracy

```{r}
# Fit the model
full.model <- glm(readmitted ~., data = train.data, family = binomial)
# Make predictions
probabilities3 <- full.model %>% predict(test.data, type = "response")
predicted.classes3 <- ifelse(probabilities3 > 0.5, "YES", "NO")
# Model accuracy
mean(predicted.classes3 == observed.classes)
```

Coefficients of the optimal elastic net model

```{r}
coef(enet.model1)
```

Coefficients of the simplest elastic net model

```{r}
coef(enet.model2)
```

Summary of the complete logistic regression model

```{r}
summary(full.model)
```



```{r}
min.enet.table <- table(predicted.classes1,observed.classes)
sensitivity1 <- min.enet.table[2,2]/(min.enet.table[2,2]+min.enet.table[1,2])*100
FP_rate1 <- min.enet.table[2,1]/(min.enet.table[2,1]+min.enet.table[1,1])*100
min.enet.table
sensitivity1
FP_rate1
ppv1 <- min.enet.table[2,2]/(min.enet.table[2,2]+min.enet.table[1,1])*100
npv1 <- min.enet.table[1,1]/(min.enet.table[1,1]+min.enet.table[1,2])*100
ppv1
npv1
```



```{r}
opt.enet.table <- table(predicted.classes2,observed.classes)
sensitivity2 <- opt.enet.table[2,2]/(opt.enet.table[2,2]+opt.enet.table[1,2])*100
FP_rate2 <- opt.enet.table[2,1]/(opt.enet.table[2,1]+opt.enet.table[1,1])*100
opt.enet.table
sensitivity2
FP_rate2
ppv2 <- opt.enet.table[2,2]/(opt.enet.table[2,2]+opt.enet.table[1,1])*100
npv2 <- opt.enet.table[1,1]/(opt.enet.table[1,1]+opt.enet.table[1,2])*100
ppv2
npv2
```



```{r}
log.reg.table <- table(predicted.classes3,observed.classes)
sensitivity3 <- log.reg.table[2,2]/(log.reg.table[2,2]+log.reg.table[1,2])*100
FP_rate3 <- log.reg.table[2,1]/(log.reg.table[2,1]+log.reg.table[1,1])*100
log.reg.table
sensitivity3
FP_rate3
ppv3 <- log.reg.table[2,2]/(log.reg.table[2,2]+log.reg.table[1,1])*100
npv3 <- log.reg.table[1,1]/(log.reg.table[1,1]+log.reg.table[1,2])*100
ppv3
npv3
```



